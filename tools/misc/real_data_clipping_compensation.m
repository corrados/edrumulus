
% PD-80R:
x_pd80r = [1025.33 700.00 8 407.35 5.56
1192.32 700.00 9 627.78 14.54
804.60 700.00 4 689.07 1.98
794.57 700.00 4 683.59 1.96
1071.58 700.00 8 534.07 7.29
1362.48 700.00 11 495.48 39.11
1346.50 700.00 10 549.48 22.85
1754.45 700.00 13 401.91 135.09
1722.40 700.00 12 520.34 82.43
1514.40 700.00 11 570.35 45.02
1190.39 700.00 10 599.89 24.95
1153.38 700.00 9 644.89 14.94
986.43 700.00 6 672.90 3.76
877.44 700.00 5 662.44 2.58
778.52 700.00 3 666.52 1.49
920.51 700.00 7 594.49 5.05
1146.48 700.00 10 556.45 23.14
1271.41 700.00 11 629.40 49.69
916.48 700.00 7 664.97 5.65
1169.47 700.00 10 641.94 26.70
1226.45 700.00 11 582.91 46.02
1017.46 700.00 8 629.45 8.59
869.45 700.00 5 650.96 2.54
851.47 700.00 5 642.47 2.50
1105.46 700.00 8 644.95 8.80
746.49 700.00 4 644.98 1.85
792.52 700.00 6 634.03 3.55
720.55 700.00 2 682.55 1.25
914.55 700.00 7 574.55 4.88
816.75 700.00 7 496.25 4.22
701.72 700.00 1 682.72 1.09
762.72 700.00 3 659.22 1.47
784.72 700.00 5 618.70 2.41
848.74 700.00 5 624.72 2.43
871.71 700.00 6 643.71 3.60
825.71 700.00 5 633.71 2.47
753.73 700.00 3 643.23 1.44
858.71 700.00 6 640.20 3.58
734.71 700.00 3 630.21 1.41
826.67 700.00 5 677.67 2.64
741.66 700.00 3 648.66 1.45
744.63 700.00 3 647.65 1.44
704.65 700.00 1 694.15 1.11
848.59 700.00 7 601.09 5.11
863.53 700.00 4 698.55 2.00
972.52 700.00 6 665.52 3.72
855.53 700.00 7 606.01 5.15
778.52 700.00 4 630.01 1.81
1018.49 700.00 8 626.46 8.55
904.44 700.00 6 679.94 3.80
922.43 700.00 6 642.42 3.59
1050.42 700.00 8 655.40 8.94
933.43 700.00 6 656.40 3.67
1026.37 700.00 8 605.38 8.26
986.35 700.00 8 619.37 8.45
985.40 700.00 6 673.87 3.77
823.36 700.00 5 606.36 2.36
729.40 700.00 3 698.40 1.56
721.39 700.00 4 661.88 1.90
838.36 700.00 5 638.36 2.49
768.36 700.00 5 663.86 2.59
1146.30 700.00 10 555.30 23.10
1126.30 700.00 9 626.76 14.52
1170.28 700.00 9 663.25 15.37
1146.27 700.00 9 612.23 14.18
1162.23 700.00 10 627.20 26.09
1186.16 700.00 11 528.65 41.73
1056.15 700.00 9 586.13 13.58
947.15 700.00 6 633.64 3.55
819.17 700.00 4 696.66 2.00
746.16 700.00 3 685.16 1.53
986.14 700.00 8 512.61 7.00
839.14 700.00 5 639.62 2.49
1238.13 700.00 9 650.56 15.07
1139.08 700.00 9 633.57 14.68
1367.07 700.00 11 631.00 49.81
1306.00 700.00 11 570.97 45.07
1109.04 700.00 9 617.00 14.30
860.08 700.00 6 633.08 3.54
874.14 700.00 5 667.14 2.60
1342.07 700.00 11 492.06 38.84
1186.06 700.00 11 558.55 44.09
1328.03 700.00 12 501.00 79.37
1306.01 700.00 11 478.98 37.81
1102.02 700.00 9 603.49 13.98
1332.02 700.00 11 440.47 34.77
1609.95 700.00 13 461.91 155.26
1258.19 700.00 10 654.67 27.23
858.30 700.00 5 612.82 2.39
858.36 700.00 7 543.34 4.62
979.36 700.00 8 560.33 7.65
1270.33 700.00 10 604.78 25.15
1364.29 700.00 12 452.75 71.72
977.33 700.00 7 680.81 5.79
1127.26 700.00 9 623.27 14.44
1290.24 700.00 11 482.70 38.10
1393.24 700.00 11 529.66 41.81
1136.23 700.00 9 572.19 13.26
895.23 700.00 6 586.72 3.28
838.28 700.00 6 617.78 3.46
724.27 700.00 2 679.28 1.25
864.30 700.00 6 651.82 3.65
920.32 700.00 7 581.80 4.94
912.31 700.00 6 672.80 3.76
773.30 700.00 5 591.79 2.30
794.32 700.00 3 653.30 1.46
793.30 700.00 3 682.30 1.52
806.33 700.00 5 628.31 2.45
746.39 700.00 3 683.39 1.52
840.40 700.00 5 662.89 2.58
930.39 700.00 6 669.36 3.75
1022.36 700.00 8 562.83 7.68
1063.37 700.00 8 420.34 5.74
1146.31 700.00 7 679.79 5.78
1113.31 700.00 8 655.78 8.95
1242.30 700.00 10 390.75 16.25
1300.24 700.00 11 515.20 40.67
1274.22 700.00 11 553.66 43.71
1306.19 700.00 11 514.62 40.62
1406.16 700.00 10 640.07 26.62
1408.09 700.00 11 675.55 53.33
1045.10 700.00 8 585.59 7.99
794.25 700.00 5 652.71 2.54
789.22 700.00 4 690.21 1.98
911.17 700.00 6 690.18 3.86
970.19 700.00 6 678.66 3.80
794.18 700.00 5 659.68 2.57
890.16 700.00 7 622.64 5.29
933.13 700.00 8 582.13 7.94
749.14 700.00 4 663.13 1.90
762.28 700.00 5 549.27 2.14
870.26 700.00 5 668.24 2.60
733.26 700.00 3 648.76 1.45
896.24 700.00 6 679.23 3.80
734.24 700.00 2 694.73 1.28
778.28 700.00 4 648.27 1.86
846.29 700.00 5 657.77 2.56
935.41 700.00 8 607.41 8.29
730.45 700.00 3 676.94 1.51
956.41 700.00 8 574.91 7.85
1252.37 700.00 11 495.35 39.10
1415.36 700.00 10 641.30 26.67
1530.29 700.00 12 446.27 70.70
1178.29 700.00 10 583.26 24.26
1194.28 700.00 10 547.75 22.78
1194.25 700.00 9 623.73 14.45
1018.23 700.00 8 585.22 7.99
1474.19 700.00 12 570.63 90.40
927.20 700.00 8 630.67 8.61
989.17 700.00 8 588.16 8.03
1190.15 700.00 10 548.12 22.80
984.14 700.00 7 660.12 5.61
750.19 700.00 4 680.70 1.95
727.18 700.00 2 690.69 1.27
1018.17 700.00 7 535.18 4.55
1049.38 700.00 8 650.32 8.87
890.39 700.00 5 658.89 2.57
938.38 700.00 7 596.40 5.07
752.43 700.00 3 673.94 1.50
945.40 700.00 7 652.40 5.54
1178.39 700.00 9 670.87 15.54
1082.35 700.00 9 575.34 13.33
1009.34 700.00 8 592.84 8.09
1192.34 700.00 9 666.30 15.44
1228.28 700.00 10 607.75 25.28
1098.28 700.00 9 576.26 13.35
1050.27 700.00 7 629.26 5.35
837.30 700.00 6 619.79 3.47
858.31 700.00 7 590.79 5.02
813.35 700.00 5 618.33 2.41
917.42 700.00 7 626.38 5.32
826.42 700.00 4 659.42 1.89
823.44 700.00 6 649.93 3.64
880.42 700.00 6 625.41 3.50
842.39 700.00 6 674.38 3.77
954.38 700.00 6 658.87 3.69
961.42 700.00 6 632.39 3.54
794.39 700.00 6 603.90 3.38
1068.09 1045.42 8 691.06 1.49
1655.98 1279.38 11 584.94 1.83
1816.91 912.12 12 359.38 1.30
1847.84 958.72 11 438.33 1.37
1869.88 845.82 12 333.26 1.21
1587.82 982.95 12 387.29 1.40
975.83 951.28 8 628.83 1.36
829.82 797.38 5 678.33 1.14
896.82 774.12 6 613.32 1.11
1215.80 1001.06 10 524.27 1.43
1869.79 1239.02 12 488.18 1.77
1853.75 1147.61 11 524.70 1.64
1869.78 1211.04 12 477.16 1.73
1819.69 606.22 11 277.17 0.87
1869.69 748.97 12 295.10 1.07
1872.66 1427.71 12 562.53 2.04
1869.76 1068.54 13 358.15 1.53
1629.68 1131.15 13 379.14 1.62
1191.67 1204.17 10 630.65 1.72
1276.64 1186.93 10 621.62 1.70
1405.59 1036.92 11 474.08 1.48
1323.56 939.52 11 429.55 1.34
1844.50 1050.03 13 351.95 1.50
1869.48 1333.47 12 525.39 1.90
1738.41 904.52 12 356.39 1.29
1726.39 1154.43 12 454.85 1.65
1869.39 1279.17 13 428.75 1.83
1136.35 1024.71 9 606.84 1.46
1281.32 1233.11 11 563.78 1.76
804.53 720.90 4 650.02 1.03
810.53 755.27 4 681.02 1.08
1158.49 1028.15 10 538.46 1.47
1149.44 1153.12 10 603.91 1.65
1766.35 1841.64 13 617.28 2.63
1167.32 1111.84 10 582.29 1.59
1434.28 1411.71 12 556.22 2.02
1350.24 1400.27 11 640.21 2.00
1184.26 1249.16 10 654.21 1.78
1507.22 1684.34 12 663.64 2.41
839.21 790.77 5 672.71 1.13
1101.21 1047.87 8 692.68 1.50
1006.19 936.56 7 682.17 1.34
927.19 859.68 7 626.17 1.23
893.18 681.80 6 540.18 0.97
930.18 841.12 7 612.66 1.20
1071.14 902.77 9 534.63 1.29
855.14 780.84 6 618.64 1.12
746.15 709.39 4 639.65 1.01
967.15 855.67 8 565.62 1.22
716.15 677.44 2 660.14 0.97
1084.14 810.26 8 535.61 1.16
777.12 744.84 4 671.61 1.06
867.12 802.26 6 635.61 1.15
823.12 748.62 6 593.11 1.07
1030.11 856.36 8 566.09 1.22
1006.10 775.40 8 512.57 1.11
1002.09 914.43 7 666.05 1.31
1000.06 803.90 7 585.55 1.15
851.07 778.25 5 662.05 1.11
978.10 862.30 7 628.08 1.23
744.11 703.06 2 685.10 1.00
935.13 867.15 7 631.62 1.24
1085.12 1009.92 8 667.59 1.44
722.12 690.75 2 673.11 0.99
1186.11 1097.07 10 574.56 1.57
1202.06 944.26 10 494.53 1.35
1232.02 950.87 10 497.99 1.36
803.03 767.05 5 652.53 1.10
746.02 711.48 4 641.53 1.02
759.02 733.65 4 661.53 1.05
797.05 731.81 5 622.55 1.05
1053.02 944.00 8 624.01 1.35
824.02 770.57 5 655.52 1.10
782.02 745.29 5 634.02 1.06
1002.00 972.67 8 642.97 1.39
1817.88 1146.91 14 322.82 1.64
1359.88 1326.18 11 606.34 1.89
1613.81 1312.03 13 439.77 1.87
1263.80 1261.51 11 576.77 1.80
1230.79 973.35 10 509.77 1.39
1340.79 907.14 11 414.75 1.30
1006.81 1010.96 8 668.28 1.44
889.82 864.66 7 629.80 1.24
854.03 793.31 6 628.52 1.13
920.02 878.66 7 640.00 1.26
906.00 855.76 6 678.00 1.22
942.02 835.42 7 608.50 1.19
802.02 764.69 5 650.52 1.09
893.01 812.75 7 591.99 1.16
1096.00 926.65 7 674.96 1.32
1153.98 971.80 10 508.95 1.39
1266.93 1264.81 10 662.41 1.81
1244.90 1117.41 11 510.89 1.60
1357.89 1257.16 12 495.33 1.80
860.88 835.41 6 661.88 1.19
1868.84 1730.91 14 487.20 2.47
1299.78 1166.32 11 533.25 1.67
1180.77 1220.58 10 639.24 1.74
956.80 882.36 8 583.27 1.26
732.90 716.40 3 675.88 1.02
1046.86 977.80 8 646.36 1.40
811.91 760.34 6 602.40 1.09
924.90 864.47 6 684.90 1.23
709.94 697.43 1 692.94 1.00
764.93 738.53 4 665.92 1.06
801.92 761.05 5 647.42 1.09
716.00 693.73 2 676.01 0.99
796.99 758.78 5 645.49 1.08
961.97 890.95 7 648.95 1.27
830.98 795.75 6 630.46 1.14
930.96 804.45 7 585.95 1.15
910.97 820.98 6 650.44 1.17
701.96 684.87 1 680.46 0.98
929.96 751.58 7 547.44 1.07
780.96 721.12 5 613.46 1.03
710.95 692.12 2 674.44 0.99
750.00 614.94 4 554.49 0.88
873.01 744.69 6 590.00 1.06
976.00 813.42 7 592.48 1.16
1121.98 873.56 8 577.45 1.25
1209.95 990.20 9 586.40 1.41
1052.90 858.34 8 567.39 1.23
1471.84 1331.91 12 524.78 1.90
1868.84 1242.37 14 349.69 1.77];

% PD8: (mean_neighbor_x)
x_pd8 = [824.64 746.34 1 606.65 1.07
859.65 802.93 1 652.65 1.15
795.63 1627.94 3 252.14 2.33
964.62 513.46 2 224.13 0.73
997.56 632.43 2 276.06 0.90
747.56 534.62 1 434.56 0.76
1360.49 903.81 2 303.99 1.29
1867.54 780.12 2 340.53 1.11
1867.61 676.04 2 295.10 0.97
1674.83 870.12 2 379.82 1.24
1867.77 866.55 2 378.26 1.24
1680.80 754.39 2 329.30 1.08
1053.82 723.53 2 315.83 1.03
1092.79 468.05 2 204.31 0.67
1112.77 400.42 2 174.79 0.57
1514.75 702.80 2 306.78 1.00
1665.76 706.82 2 289.26 1.01
763.72 590.19 1 479.73 0.84
779.71 548.35 1 445.71 0.78
1018.66 399.01 2 174.18 0.57
1088.64 428.75 2 187.16 0.61
1103.61 475.29 2 202.13 0.68
1070.60 641.67 2 280.10 0.92
903.57 632.47 2 276.08 0.90
1252.56 771.47 1 627.07 1.10
996.57 852.35 2 372.06 1.22
941.56 607.22 1 493.57 0.87
969.55 398.77 2 174.07 0.57
763.57 535.26 1 435.07 0.76
1867.59 718.37 2 313.58 1.03
1849.72 935.17 2 408.22 1.34
1867.67 561.66 2 245.17 0.80
1405.63 652.97 2 254.64 0.93
984.65 423.06 2 184.67 0.60
1186.64 457.40 2 199.66 0.65
1465.67 565.09 2 246.67 0.81
1867.65 591.38 2 258.15 0.84
1867.85 857.57 2 374.34 1.23];


close all;

x = x_pd80r;

[~, idx] = sort(x(:,1));
x = x(idx,:);

%figure; plot(x);

y = x;

% amplification_compensation = amplification_mapping[min ( length_ampmap - 1, 1 + number_overloaded_samples )] * mean_neighbor / new_clip_level;

ampmap_const_step     = 0.053; % PD80R
%ampmap_const_step     = 0.4; % PD8
clip_limit            = 700;

amplification_mapping = transpose(10 .^ ([0:ampmap_const_step:ampmap_const_step * 20] .^ 2));
amplification_mapping(amplification_mapping > 5) = 5; % never to higher than 5
%amplification_compensation = amplification_mapping(1 + y(:, 3)) .* y(:, 4) ./ clip_limit;


% new test -> enable new test by enabling the last line of this block
ampmap_const_step     = 0.045; % PD80R
amplification_mapping = transpose(10 .^ ([0:ampmap_const_step:ampmap_const_step * 20] .^ 2));
amplification_mapping(amplification_mapping > 5) = 5; % never to higher than 5
a_low  = amplification_mapping(1 + y(:, 3));
a_high = amplification_mapping(1 + y(:, 3) + 1);
r      = y(:, 4) ./ clip_limit;
a_diff = a_high - a_low;
%amplification_compensation = amplification_mapping(1 + y(:, 3)) + r .* a_diff;


% new test -> enable new test by enabling the last line of this block
ampmap_const_step          = 0.05;%0.09;%0.05; % PD80R
amplification_mapping      = transpose(10 .^ ([0:ampmap_const_step:ampmap_const_step * 20] .^ 2));
amplification_mapping(amplification_mapping > 5) = 5; % never to higher than 5
a_low                      = amplification_mapping(1 + y(:, 3));
a_high                     = amplification_mapping(1 + y(:, 3) + 1);
a_diff                     = a_high - a_low;
a_diff_abs                 = a_diff * clip_limit ./ a_low;
neighbor_to_limit_abs      = (y(:, 4) - (clip_limit - a_diff_abs));
neighbor_to_limit_abs      = max(0, min(a_diff_abs, neighbor_to_limit_abs));
amplification_compensation = a_low + neighbor_to_limit_abs ./ a_diff_abs .* a_diff;


% new test2 -> enable new test by enabling the last line of this block
ampmap_const_step     = 0.055; % PD80R
amplification_mapping = transpose(10 .^ ([0:ampmap_const_step:ampmap_const_step * 20] .^ 2));
%amplification_compensation = amplification_mapping(1 + y(:, 3)) + y(:, 4) / clip_limit - 1;



%figure; plot(20 * log10(700:2000), 20 * log10(700:2000), 'k-.');
%xlabel('true'); ylabel('est'); grid on; hold on;
%plot(20 * log10(y(:, 1)), 20 * log10(clip_limit * amplification_compensation));

figure; plot(500:2000, 500:2000, 'k-.');axis([500, 2000, 500, 2000]);
xlabel('true'); ylabel('est'); grid on; hold on;
plot(y(:, 1), clip_limit * amplification_compensation);

%figure; plot(y(:, 1)); grid on; hold on;
%plot(clip_limit * amplification_compensation, 'g')
%plot(y(:, 4), 'r')

%plot(amplification_compensation); grid on; hold on; plot(y(:, 5))
%plot(20 * log10(amplification_compensation)); grid on; hold on; plot(20 * log10(y(:, 5)))


%figure;plot(y(:,3))




